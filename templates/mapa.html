<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Mapa de Clientes</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  html, body { height: 100%; margin: 0; }
  #map { height: 100%; }

  .panel {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 999;
    background: white;
    padding: 10px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,.25);
    width: 92%;
    max-width: 360px;
  }

  .panel b { display: block; margin-bottom: 6px; }
  .panel input, .panel button {
    width: 100%;
    padding: 10px;
    margin-top: 6px;
    font-size: 16px;
    border-radius: 6px;
    border: 1px solid #ddd;
  }

  .panel button {
    background: #1976d2;
    color: white;
    border: none;
    cursor: pointer;
  }

  .panel button.secondary {
    background: #e0e0e0;
    color: #333;
  }

  .go-btn {
    display: inline-block;
    margin-top: 8px;
    padding: 8px 10px;
    background: #e53935;
    color: white;
    text-decoration: none;
    border-radius: 6px;
    font-size: 14px;
  }

  @media (max-width: 600px) {
    .panel {
      top: auto;
      bottom: 10px;
      left: 10px;
      right: 10px;
      width: auto;
      max-width: none;
    }
  }
</style>
</head>
<body>

<div class="panel">
  <b>Buscar cliente por SERIALNUMBER</b>
  <input id="serial" type="number" placeholder="Ej: 12345678" />
  <button onclick="buscar()">Buscar</button>
  <button class="secondary" onclick="cargarTodos()">Mostrar varios</button>
</div>

<div id="map"></div>

<script>
  const map = L.map('map', { zoomControl: false }).setView([13.7, -89.2], 10);
  L.control.zoom({ position: 'topright' }).addTo(map);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  const markersLayer = L.layerGroup().addTo(map);

  let userLat = null;
  let userLon = null;

  // Icono rojo para el cliente buscado
  const redIcon = new L.Icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41]
  });

  // Tu ubicaci贸n
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      userLat = pos.coords.latitude;
      userLon = pos.coords.longitude;

      L.marker([userLat, userLon])
        .addTo(map)
        .bindPopup(" Tu ubicaci贸n")
        .openPopup();

      map.setView([userLat, userLon], 13);
    });
  }

  function pintarClientes(data, esBusqueda = false) {
    markersLayer.clearLayers();

    if (!data || data.length === 0) {
      alert("No se encontr贸 el cliente");
      return;
    }

    const bounds = [];

    data.forEach(c => {
      const lat = parseFloat(c.LATITUDE);
      const lon = parseFloat(c.LONGITUDE);
      if (isNaN(lat) || isNaN(lon)) return;

      const marker = L.marker([lat, lon], esBusqueda ? { icon: redIcon } : {})
        .addTo(markersLayer);

      let popupHtml = `
         Cliente<br>
        Serial: ${c.SERIALNUMBER}
      `;

      if (userLat && userLon && esBusqueda) {
        const gmaps = `https://www.google.com/maps/dir/?api=1&origin=${userLat},${userLon}&destination=${lat},${lon}`;
        popupHtml += `<br><a class="go-btn" href="${gmaps}" target="_blank">Л C贸mo llegar</a>`;
      }

      marker.bindPopup(popupHtml);
      bounds.push([lat, lon]);
    });

    if (bounds.length > 0) {
      map.fitBounds(bounds, { padding: [40, 40] });
    }
  }

  function buscar() {
    const serial = document.getElementById("serial").value.trim();
    if (!serial) {
      alert("Ingresa un SERIALNUMBER v谩lido");
      return;
    }

    fetch(`/api/clientes?serial=${serial}`)
      .then(r => r.json())
      .then(data => pintarClientes(data, true))
      .catch(() => alert("Error al buscar cliente"));
  }

  function cargarTodos() {
    fetch("/api/clientes")
      .then(r => r.json())
      .then(data => pintarClientes(data, false))
      .catch(() => alert("Error al cargar clientes"));
  }
</script>

</body>
</html>
